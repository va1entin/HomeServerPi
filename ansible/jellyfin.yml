---
- name: Jellyfin
  hosts: "pi4"
  vars:
    jellyfin_version: 10.8.0-beta3
    host_config_dir: /etc/jellyfin
    host_cache_dir: /var/cache/jellyfin
  vars_files:
    - secrets.yml
  tasks:
    - name: Ensure {{ host_config_dir }} dir exists
      ansible.builtin.file:
        path: "{{ host_config_dir }}"
        state: directory

    - name: Ensure {{ host_cache_dir }} dir exists
      ansible.builtin.file:
        path: "{{ host_cache_dir }}"
        state: directory

    # ansible-galaxy collection install community.docker
    - name: Start Jellyfin container
      community.docker.docker_container:
        name: jellyfin
        image: "jellyfin/jellyfin:{{ jellyfin_version }}"
        detach: true
        network_mode: host
        restart: true
        restart_policy: always
        pull: true
        volumes:
          - "/etc/localtime:/etc/localtime:ro"
          - "{{ host_config_dir }}:/config"
          - "{{ host_cache_dir }}:/cache"
        mounts:
          - source: "/home/mediaserver"
            target: "/media"
            read_only: true
            type: bind
        env:
          TZ: "Europe/Berlin"
        state: started
